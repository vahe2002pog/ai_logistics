from utils.openrouter_client import client
from config import LLM_MODEL


class AnalysisAgent:
    """
    Агент анализа и генерации управленческих решений
    """

    def analyze(self, context: list[str], task: str) -> dict:
        prompt = f"""
        РОЛЬ МОДЕЛИ:
        Ты выступаешь в роли интеллектуального аналитического агента
        логистической компании «Югра-Логистика».
        Твоя задача — помогать менеджеру по логистике
        принимать управленческие решения.

        КОНТЕКСТ:
        Ниже приведены фрагменты актуальных данных о посылках,
        полученные из информационной системы компании.
        Данные являются достоверными и относятся
        к текущему операционному периоду.

        ДАННЫЕ:
        {context}

        ЗАДАЧА:
        {task}

        ОГРАНИЧЕНИЯ И ТРЕБОВАНИЯ:
        - Используй ТОЛЬКО предоставленные данные
        - Не выдумывай недостающую информацию
        - Пиши на деловом, нейтральном языке
        - Формулируй выводы кратко и структурировано
        - При необходимости предложи управленческие меры

        ФОРМАТ ОТВЕТА:
        1. Краткое описание ситуации
        2. Выявленные проблемы (если есть)
        3. Рекомендованные действия
        """
        response = client.chat.completions.create(
            model=LLM_MODEL,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )

        text = response.choices[0].message.content
        return {
            "analysis": text.strip(),
            "used_context_count": len(context)
        }